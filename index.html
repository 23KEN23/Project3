<html>
    <head>
        <title>Project 3</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://code.jquery.com/jquery-1.10.2.js">
        </script>
        <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
        <script src=https://cdn.jsdelivr.net/jstat/latest/jstat.min.js></script>
        
        <style>
            body
            {
                background: -webkit-radial-gradient(#395467, #333334); /* Safari 5.1 to 6.0 */
                background: -o-radial-gradient(#395467, #333334); /* For Opera 11.6 to 12.0 */
                background: -moz-radial-gradient(#395467, #333334); /* For Firefox 3.6 to 15 */
                background: radial-gradient(#395467, #333334);
                text-align: center;
            }
            .button1{
                background-color: #CCCCCC;
                color: black;
                text-align: center;
                padding: 14px;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                margin: 4px 6px;
                cursor: pointer;
                -webkit-transition-duration: 0.4s; /* Safari */
                transition-duration: 0.4s;
                border: 1px solid;
                outline: none;
                /*width:100%;*/
                border-radius: 6px;
                font-weight: 100;
                }
            
            #ShipButtonHolder{
                margin-top: 15%;
                margin-bottom: 10px;
            }
            
            #BoardButtonHeatMapHolder
            {
                text-align: center;
            }
            #BoardButtonHolder{
                /*display: inline-block;
                float: left;
                width:150px;*/
                width:750px;
                height:750px;
                margin-top: 30px;
                margin-bottom: 40px;
                display:inline-block;
            }
            
            .button2{
                background-color: transparent;
                color: #3EDFED;
                text-align: center;
                padding: 14px;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                cursor: pointer;
               -webkit-transition: all 0.5s ease-in-out;
                -moz-transition: all 0.5s ease-in-out;
                -o-transition: all 0.5s ease-in-out;
                -ms-transition: all 0.5s ease-in-out;
                transition: all 0.5s ease-in-out;
                border: 1px solid;
                border-color: rgba(222,153,144,0.5);
                outline: none;
                /*width:100%;*/
                border-radius: 50%;
                font-weight: 500;
                width:30px;
                height:30px;
                margin: 20px;
                /*-webkit-transition-duration: 0.4s;*/ /* Safari */
                /*transition-duration: 0.4s;*/
                
                }
            
            
        </style>
        
    </head>

    <body>
        <div id="ShipButtonHolder"></div>
        <div id="ExecuteGame"></div>
        <div id="BoardButtonHeatMapHolder">
            <div id="BoardButtonHolder"></div>
        </div>
        <script>
            
            function Ship(name) {
                //name = string of name of ship
                //length = length of ship
                var l;
                if(name=="Carrier"){
                    l = 5;
                }
                if(name=="Battleship"){
                    l = 4;
                }
                if(name=="Cruiser"){
                    l = 3;
                }
                if(name=="Submarine"){
                    l = 3;
                }
                if(name=="Destroyer"){
                    l = 2;
                }
                
                this.name = name;
                this.len = l;
                this.valid_placements = [];
            }
              
            
            function ValidPlacement(Board, i, j, k, length){
                // Board = Two dimensional array representing board
                // i = row
                // j = column
                // k = orientation
                
                var occupied = 0;
                
                //Horizontal Ship
                if (k == 0){
                    if (j>10-length){
                        return 0;
                        }
                    else{
                        for(l = 0; l<length; l++){
                            occupied = occupied+Board[i][j+l];
                        }
                        if (occupied == 0){
                            return 1;
                        }
                        else{
                            return 0;
                        }
                    }
                }
            
                //Vertical Ship
                if (k == 1){
                    if (i>10-length){
                        return 0;
                        }
                    else{
                        for(l = 0; l<length; l++){
                            occupied = occupied+Board[i+l][j];
                        }
                        if (occupied == 0){
                            return 1;
                        }
                        else{
                            return 0;
                        }
                    }
                }
            }
            
            
            function ValidLocations(Board, Ship_List) {
                //Board = 2d Array
                //Ship_List = list of ship objects
                
                Ship_List.forEach(function(ship) {
                    var valid_placements = []
                    var len = ship.len
                    
                    for(i = 0; i<10; i++){
                        for(j = 0; j<10; j++){
                            for(k = 0; k<2; k++){
                                if (ValidPlacement(Board,i,j,k,len)==1){
                                    valid_placements.push([i,j,k]);
                                }
                            }
                        }
                    }
                    ship.valid_placements = valid_placements
                });
            
            }
            
            
            function SpacesOccupied(length, location) {
                //length = length of ship
                //location = [i,j,k]
                //Returns: list of spaces occupied by ship
                
                var occupied = [];
                var i = location[0];
                var j = location[1];
                var k = location[2];
                
                if (k==0){
                    for(l = 0; l<length; l++){
                        occupied.push([i,j+l]);
                    }
                }
                
                if (k==1){
                    for(l = 0; l<length; l++){
                        occupied.push([i+l,j]);
                    }
                }
                
                return occupied;
            
            }
            
            
            function RandomSample(Ship_List) {
                var PDF = math.zeros(10,10).toArray();
                var spaces_occ = [];
                
                Ship_List.forEach(function(ship){
                    var locations = ship.valid_placements;
                    var index = Math.floor(Math.random()*locations.length);
                    var location = locations[index];
                    var spaces = SpacesOccupied(ship.len,location);
                    spaces_occ = spaces_occ.concat(spaces);
                });
                
                var fail = 0;
                spaces_occ.forEach(function(space){
                    var i = space[0];
                    var j = space[1];
                    if (PDF[i][j] != 0){
                        fail = 1;                        
                    }  
                    PDF[i][j] = 1;
                });
                
                //Check if valid configuration
                if(fail == 1){
                    return false;
                }
                else{
                    return PDF;
                }
            }
            
            
            function NSamples(N,M,Ship_List) {
                //N = Number of Samples Wanted
                //M = Number of iterations
                
                var PDF = math.zeros(10,10).toArray();
                var n = 0;
                var m = 0;
                
                while( (n<N) && (m<M) ){
                    m = m+1;
                    var Result = RandomSample(Ship_List);
                    if (typeof(Result) != "boolean"){
                        n = n+1;
                        PDF = math.add(PDF,Result);
                    }
                }
                return [PDF,n];            
            }
            
            
            function PDF(matrix,n){
                return math.divide(matrix,n);
            }
            
            
            function BinomialCI(a,k,n){
                //a = percentage of confidence interval
                //n = number of trials
                //k = number of successes
                var alpha = 1-a;
                var ub = 1-jStat.beta.inv(alpha/2,n-k,k+1);
                var lb = 1-jStat.beta.inv(1-(alpha/2),n-k+1,k);
                
                var CI = [lb,ub];
                return CI;
            }
            
            
            function CALCULATE(){
                var Enemy_Ships = ShipstoArray(Ship_Dict);
                var Board = BoardtoMatrix(Board_Dict);

                ValidLocations(Board,Enemy_Ships);

                var samples = NSamples(20000,40000,Enemy_Ships);
                var pdf = samples[0];
                var n = samples[1];
                
                return [pdf,n];
            }
            
            
            function ShipstoArray(dict){
                var Enemy_Ships = []
                var keys = Object.keys(dict);
                keys.forEach(function(name){
                    var ship = new Ship(name);
                    Enemy_Ships.push(ship);
                })
                return Enemy_Ships;
            }    
            
            
            function BoardtoMatrix(dict){
                var Board = math.zeros(10,10).toArray();
                var keys = Object.keys(dict);
                keys.forEach(function(location){
                    var i = parseInt(location[0]);
                    var j = parseInt(location[2]);
                    Board[i][j] = 1;
                })
                return Board;
            }
            
            
            function makeButtonDark(btn)
            {
                d3.select(btn).style("background-color","#848482");
                d3.select(btn).style("color","white");
                d3.select(btn).style("font-weight",500); 
            }
            
            function makeButtonLight(btn)
            {
                d3.select(btn).style("background-color","#CCCCCC");
                d3.select(btn).style("color","black");
                d3.select(btn).style("font-weight",500); 
            }
            
            function generateHeatMap() {
                var maxVal =  d3.max(pdf, function(d) { return d3.max(d); });

                var colorScale = d3.scaleLinear()
                    .domain([0,0.0000000001,  maxVal/2, maxVal])
                    .range(['black','grey', 'orange', 'red']);

                for (var i = 0; i < 10; i++) {
                    for (var j = 0; j < 10; j++) {
                        var button = d3.select("#BoardButtonHolder").select("#button" + (i*10+j));
                        button.style("background-color", colorScale(pdf[i][j]));
                    }
                }
                var height = 750;
                var gridSize = Math.floor(750/24);
                var legendElementWidth = gridSize * 2;
                var legend = d3.select("#BoardButtonHolder").selectAll(".legend")
                  .data([0].concat(colorScale.quantiles()), function(d) { return d; });

                legend.enter().append("g")
                  .attr("class", "legend");

                legend.append("rect")
                    .attr("x", function(d, i) { return legendElementWidth * i; })
                    .attr("y", height)
                    .attr("width", legendElementWidth)
                    .attr("height", gridSize / 2)
                    .style("fill", function(d, i) { return colorScale[i]; });

                legend.append("text")
                    .attr("class", "mono")
                    .text(function(d) { return "≥ " + Math.round(d); })
                    .attr("x", function(d, i) { return legendElementWidth * i; })
                    .attr("y", height + gridSize);

                legend.exit().remove();
            }
    
            
            var Board_Dict = {};
            var Ship_Dict = {};
            var N;
            var count_matrix;
            var pdf;
                    
            //Adding buttons for Ships
            var Game_Ships = ["Carrier", "Battleship", "Cruiser", "Submarine", "Destroyer"];
            
            var Ship_BH = d3.select("#ShipButtonHolder");
            var ship_buttons = Ship_BH.selectAll("input").data(Game_Ships);

            ship_buttons.enter()
            .append("input")
            .attr("type","button")
            .attr("class","button button1")
            .attr("clicked","false")
            .attr("id",function(d,i){return "button"+i})
            .attr("value", function (d){return d; })
            .style("color","transparent")
            .on("click", function(d){
                if(d3.select(this).attr("clicked")=="false"){
                    d3.select(this).attr("clicked","true");
                    makeButtonDark(this);
                    Ship_Dict[this.value] = 1;
                }
                else{
                    d3.select(this).attr("clicked","false");
                    makeButtonLight(this);
                    delete Ship_Dict[this.value];
                }
            })
            .on("mouseover", function(d)
               {
                makeButtonDark(this)
            })
            .on("mouseout",function(d)
               {
                   if(d3.select(this).attr("clicked")=="false")
                    {
                        makeButtonLight(this);
                    }
            });
            
            var calculateClicked = false;
            
            d3.select("#ExecuteGame").append("input")
                .attr("type", "button")
                .attr("class","button button1")
                .attr("clicked","false")
                .attr("id", "execute")
                .attr("value", "Calculate")
                .on("click", function(d){
                    /* first check at least 1 ship button has been pressed */
                    if (Object.keys(Ship_Dict).length < 1) {
                        alert("Please select at least one type of ship to search for!");
                        return;
                    }
                    var result = CALCULATE();
                    count_matrix = result[0];
                    N = result[1];
                    pdf = PDF(count_matrix, N);
                    generateHeatMap();
                    calculateClicked = true;
                })
                .on("mouseover", function() {
                    makeButtonDark(this)
                })
                .on("mouseout",function() {
                       if(d3.select(this).attr("clicked") == "false") {
                            makeButtonLight(this);
                        }
                });

             d3.select("#ExecuteGame").append("input")
                .attr("type", "button")
                .attr("class","button button1")
                .attr("clicked","false")
                .attr("id", "execute")
                .attr("value", "Refresh")
                .on("click", function(d){
                    var buttons = d3.select("#BoardButtonHolder").selectAll(".button.button2");

                })
                .on("mouseover", function() {
                    makeButtonDark(this)
                })
                .on("mouseout",function() {
                       if(d3.select(this).attr("clicked") == "false") {
                            makeButtonLight(this);
                        }
                });

            
            
            //Adding buttons for Board
            var Board_Cells = [];
            
            for(i=0;i<10;i++){
                for(j=0;j<10;j++){
                    Board_Cells.push([i,j]);
                }
            }
            
            var Board_BH = d3.select("#BoardButtonHolder");
            var board_buttons = Board_BH.selectAll("input").data(Board_Cells);
            
            board_buttons.enter()
            .append("input")
            .attr("type","button")
            .attr("class","button button2")
            .attr("clicked","false")
            .attr("id",function(d,i){return "button"+i})
            .style("color","transparent")
            .attr("value", function (d){return d; })
            .on("click", function(d){
                if(d3.select(this).attr("clicked")=="false"){
                    d3.select(this).attr("clicked","true");
                    makeButtonPink(this);
                    Board_Dict[this.value] = 1
                }
                else{
                    d3.select(this).attr("clicked","false");
                    makeButtonTransparent(this);
                    delete Board_Dict[this.value];
                }
            })
            .on("mouseover", function(d)
               {
                if (d3.select(this).attr("clicked") == "false" && calculateClicked==false) {
                    makeButtonPink(this);
                } 
            })
            .on("mouseout",function(d)
               {
                   if(d3.select(this).attr("clicked")=="false" && calculateClicked==false)
                    {
                        makeButtonTransparent(this);
                    }
            });
            
            function makeButtonTransparent(btn){
                d3.select(btn).style("background-color","transparent");
                d3.select(btn).style("font-weight",500);
                d3.select(btn).style("transform","scale(1)");
                /*d3.select(btn).style("width",40);
                d3.select(btn).style("height",40);
                d3.select(btn).style("margin-left",20);
                d3.select(btn).style("margin-right",20);*/
            }
            
            function makeButtonPink(btn)
            {
                d3.select(btn).style("background-color","#F28573");
                d3.select(btn).style("font-weight",500); 
                d3.select(btn).style("transform","scale(1.5)");
                //d3.select(btn).style("margin:0%");
                
            }
            

        </script>        
    </body>
</html>